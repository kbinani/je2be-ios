#!/usr/bin/env ruby

default_platform :ios

platform :ios do
  lane :down_and_upload_dsyms do |opt|
    team_id = opt[:team_id]
    build_number = opt[:build_number]
    username = opt[:username]

    if team_id.nil? || build_number.nil? || username.nil?
      UI.user_error! "team_id, build_number, username not set: bundle exec fastlane down_and_upload_dsyms version:1, team_id:ABCD username:foo@example.com"
    end

    download_dsyms(
      app_identifier: "com.github.kbinani.je2be-ios",
      build_number: build_number,
      username: username,
      team_id: team_id,
    )

    dsym_path = lane_context[SharedValues::DSYM_PATHS]
    if dsym_path.nil?
      UI.user_error! "dsym_path is nil"
    end
    upload_symbols_to_bugsnag(
      api_key: "${je2be_bugsnag_api_key}",
      dsym_path: dsym_path
    )
  end
end
